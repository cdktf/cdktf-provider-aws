# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: next-cdktf-version-pr
on:
  workflow_dispatch: {}
jobs:
  pr-against-next:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      CI: "true"
      CHECKPOINT_DISABLE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
      - name: Remove old PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          PR_NUMBER_TO_CLOSE=$(gh pr list | grep "cdktf-next-pr" | awk '{ print $1 }')
          if [ -z "$PR_NUMBER_TO_CLOSE" ]; then
            echo "No PR to close"
          else
            gh pr close $PR_NUMBER_TO_CLOSE
          fi
      - name: Install
        run: yarn install
      - name: Upgrade CDKTF
        run: |-
          CDKTF_VERSION=$(yarn info cdktf --json | jq -r '.data | .["dist-tags"] | .next')
          sed -i "s/cdktfVersion: ".*",/cdktfVersion: \"$CDKTF_VERSION\",/" .projenrc.js
          cat .projenrc.js
      - name: Run projen
        run: yarn run upgrade
      - name: Regenerate bindings
        run: yarn run fetch && yarn run compile && yarn run docgen
      - name: Create PR
        uses: peter-evans/create-pull-request@284f54f989303d2699d373481a0cfa13ad5a6666
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cdktf-next-pr
          branch-suffix: random
          commit-message: "chore: upgrade CDKTF to @next preview version"
          title: "chore: preview upgrading CDKTF to @next version"
          delete-branch: true
          draft: true
          body: DO NOT MERGE! This is an automated PR that tests the pre-built provider generation against preview builds of CDKTF
